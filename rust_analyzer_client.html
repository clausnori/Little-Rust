<!DOCTYPE html>
<html>
<head>
    <title>Rust Analyzer WebSocket Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        textarea { width: 100%; height: 200px; font-family: monospace; }
        button { padding: 10px 20px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rust Analyzer WebSocket Client</h1>
        
        <div class="section">
            <h3>Соединение: <span id="status" class="disconnected">Отключено</span></h3>
            <button onclick="connect()">Подключиться</button>
            <button onclick="disconnect()">Отключиться</button>
        </div>
        
        <div class="section">
            <h3>Быстрые команды</h3>
            <button onclick="sendInitialize()">Initialize</button>
            <button onclick="sendDidOpen()">Did Open</button>
            <button onclick="sendCompletion()">Completion</button>
            <button onclick="sendHover()">Hover</button>
        </div>
        
        <div class="section">
            <h3>Отправить сообщение</h3>
            <textarea id="messageInput" placeholder='{"jsonrpc": "2.0", "id": 1, "method": "initialize", "params": {}}'></textarea>
            <br>
            <button onclick="sendMessage()">Отправить</button>
        </div>
        
        <div class="section">
            <h3>Лог сообщений</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Очистить лог</button>
        </div>
    </div>

    <script>
        let ws = null;
        let messageId = 1;
        
        function connect() {
            ws = new WebSocket('ws://localhost:8765');
            
            ws.onopen = function() {
                document.getElementById('status').textContent = 'Подключено';
                document.getElementById('status').className = 'connected';
                log('WebSocket подключен');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                log('Получено: ' + JSON.stringify(data, null, 2));
            };
            
            ws.onclose = function() {
                document.getElementById('status').textContent = 'Отключено';
                document.getElementById('status').className = 'disconnected';
                log('WebSocket отключен');
            };
            
            ws.onerror = function(error) {
                log('Ошибка: ' + error);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket не подключен');
                return;
            }
            
            const message = document.getElementById('messageInput').value;
            try {
                const parsed = JSON.parse(message);
                ws.send(message);
                log('Отправлено: ' + JSON.stringify(parsed, null, 2));
            } catch (e) {
                alert('Неверный JSON: ' + e.message);
            }
        }
        
        function sendInitialize() {
            const message = {
                "jsonrpc": "2.0",
                "id": messageId++,
                "method": "initialize",
                "params": {
                    "processId": null,
                    "clientInfo": {"name": "web-client", "version": "1.0.0"},
                    "rootUri": "file:///tmp/rust-project",
                    "capabilities": {
                        "textDocument": {
                            "completion": {"completionItem": {"snippetSupport": true}},
                            "hover": {"contentFormat": ["markdown", "plaintext"]}
                        }
                    }
                }
            };
            document.getElementById('messageInput').value = JSON.stringify(message, null, 2);
        }
        
        function sendDidOpen() {
            const message = {
                "jsonrpc": "2.0",
                "method": "textDocument/didOpen",
                "params": {
                    "textDocument": {
                        "uri": "file:///tmp/main.rs",
                        "languageId": "rust",
                        "version": 1,
                        "text": "fn main() {\n    println!(\"Hello, world!\");\n}"
                    }
                }
            };
            document.getElementById('messageInput').value = JSON.stringify(message, null, 2);
        }
        
        function sendCompletion() {
            const message = {
                "jsonrpc": "2.0",
                "id": messageId++,
                "method": "textDocument/completion",
                "params": {
                    "textDocument": {"uri": "file:///tmp/main.rs"},
                    "position": {"line": 1, "character": 12}
                }
            };
            document.getElementById('messageInput').value = JSON.stringify(message, null, 2);
        }
        
        function sendHover() {
            const message = {
                "jsonrpc": "2.0",
                "id": messageId++,
                "method": "textDocument/hover",
                "params": {
                    "textDocument": {"uri": "file:///tmp/main.rs"},
                    "position": {"line": 1, "character": 4}
                }
            };
            document.getElementById('messageInput').value = JSON.stringify(message, null, 2);
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
    </script>
</body>
</html>